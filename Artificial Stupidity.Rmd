---
title: "Artificial Stupidity"
author: "Minghao Du"
date: "10/22/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list = ls())

load_pkgs <-
  function(packages = c(),
           basic.packages = c(
             "package:stats",
             "package:graphics",
             "package:grDevices",
             "package:utils",
             "package:datasets",
             "package:methods",
             "package:base"
           )) {
    package.list <-
      search()[ifelse(unlist(gregexpr("package:", search())) == 1, TRUE, FALSE)]
    package.list <- setdiff(package.list, basic.packages)
    if (length(package.list) > 0)
      for (package in package.list)
        detach(package, character.only = TRUE)
    installed_packages <- packages %in% rownames(installed.packages())
    if (any(installed_packages == FALSE)) {
      install.packages(packages[!installed_packages], dependencies = T)
    }
    invisible(lapply(packages, library, character.only = TRUE))
  }


pkg_list <- c(
  "plotly", 
  "tidyverse", 
  "readxl", 
  "GGally", 
  "psych", 
  "janitor", 
  "e1071", 
  "lubridate", 
  "fastDummies", 
  "xgboost", 
  "tensorflow", 
  "keras", 
  "reticulate", 
  "gender", 
  "stringr")
load_pkgs(pkg_list)

# install_miniconda()
# https://www.tensorflow.org/install/source_windows 
# https://www.tensorflow.org/install/gpu#hardware_requirements 
# https://docs.anaconda.com/anaconda/user-guide/tasks/tensorflow 
# conda_create(envname = "r-reticulate", packages = "tensorflow-gpu", python_version = "3.9")

use_condaenv("r-reticulate")
```

```{r}
writeSubmit <- function(pred) {
  submissionFile = data.frame(id = scoringData$id, price = pred)
  write.csv(submissionFile, 'submission.csv', row.names = F)
}

rawData <- read_csv('./input/rentlala2021/analysisData.csv')

scoringData <- read_csv('./input/rentlala2021/scoringData.csv')

compare_df_cols(rawData, scoringData) %>%
  filter(rawData != scoringData |
           rawData %>% is.na() | scoringData %>% is.na())

rawData %>% mutate(license = license %>% as.logical()) -> rawData
scoringData %>% mutate(zipcode = zipcode %>% as.numeric()) -> scoringData

compare_df_cols(rawData, scoringData) %>%
  filter(rawData != scoringData | rawData %>% is.na() | scoringData %>% is.na())

pricedScoringData <- scoringData %>% mutate(price = -1)

allData <- rawData %>% bind_rows(pricedScoringData)


numericCols <- allData %>% select(is.numeric) %>% colnames()
boolCols <- allData %>% select(is.logical) %>% colnames()
dateCols <- allData %>% select(is.Date) %>% colnames()
charCols <- allData %>% select(is.character) %>% colnames()
longCharCols <-
  allData[charCols] %>% 
  select(c(name, 
      summary, 
      space, 
      description, 
      neighborhood_overview, 
      notes, 
      transit, 
      access, 
      interaction, 
      house_rules, 
      host_about, 
      amenities
  )) %>% 
  colnames()
factorCharCols <- 
  allData[charCols] %>% 
  select(-c(name, 
      summary, 
      space, 
      description, 
      neighborhood_overview, 
      notes, 
      transit, 
      access, 
      interaction, 
      house_rules, 
      host_about, 
      amenities
  )) %>% 
  select(-c(
    host_name, 
    host_verifications, 
    host_response_time, 
    calendar_updated, 
    host_response_rate, 
    host_acceptance_rate
  )) %>% 
  colnames()

rateCols <- allData %>% 
  select(c(host_response_rate, host_acceptance_rate)) %>% 
  colnames()

allData[rateCols] <- allData[rateCols] %>% 
  mutate(host_response_rate = gsub("N/A","0%", host_response_rate)) %>% 
  mutate(host_acceptance_rate = gsub("N/A","0%", host_acceptance_rate)) %>% 
  mutate(host_response_rate = gsub("%","", host_response_rate)) %>% 
  mutate(host_acceptance_rate = gsub("%","", host_acceptance_rate)) %>% 
  mutate_all(as.numeric) %>% 
  mutate_each(funs(./100))


allData[numericCols] <- allData[numericCols] %>% replace(is.na(.),0)
allData[boolCols] <- allData[boolCols] %>% replace(is.na(.),F)
allData <- allData %>% select(-factorCharCols) %>% 
  add_column(allData[factorCharCols] %>%  
  replace(is.na(.),"") %>% 
  dummy_cols(select_columns = factorCharCols, remove_selected_columns = T) %>%
  clean_names() %>% 
  select_if(~sum(.) != 1))
  
# allData[factorCharCols] <- allData[factorCharCols] %>%
#   mutate_all(as.factor)

allData %>% select(host_name) %>% c() -> names 

allData <- allData %>% left_join(gender(names$host_name) %>% distinct() %>% select(c(name, proportion_male, proportion_female)), by = c("host_name" = "name"))

allData <- allData %>% bind_cols(allData[longCharCols] %>% mutate_each(funs(str_count)) %>% rename_all(function(x) paste0(x,"_wcount")))

allData <- allData %>% select(is.numeric | is.factor) %>% mutate_all(as.numeric) %>% mutate_at(vars(-price), funs(scale)) %>%  replace(is.na(.),0)

trainData <- allData %>% filter(price > -1)
testData <- allData %>% filter(price == -1) %>% select(-price)

# host_verifications
# host_response_time
# calendar_updated
# 1878 1803 75
```


```{r eval = FALSE}
BoostTrainData <- trainData %>% select(!is.character)


xgb_train_rmse <- NULL
xgb_test_rmse <- NULL
round <- NULL

hyper_grid <- expand.grid(max_depth = seq(1, 10, 2), eta = seq(.01, .35, .03))

for(j in 1:nrow(hyper_grid)) {
  set.seed(123)
  m_xgb_untuned <- xgb.cv(
    data = BoostTrainData %>% select(-price) %>% as.matrix(),
    label = BoostTrainData %>% select(price) %>% as.matrix(),
    nrounds = 1000,
    objective = "reg:squarederror",
    early_stopping_rounds = 3,
    nfold = 10,
    max_depth = hyper_grid$max_depth[j],
    eta = hyper_grid$eta[j], 
    verbose = F
  )
  
  temp_train_rmse <- m_xgb_untuned$evaluation_log$train_rmse_mean[m_xgb_untuned$best_iteration]
  temp_test_rmse <- m_xgb_untuned$evaluation_log$test_rmse_mean[m_xgb_untuned$best_iteration]
  
  cat(j,"\n")
  cat(hyper_grid$max_depth[j],"\t")
  cat(hyper_grid$eta[j],"\n")
  cat(m_xgb_untuned$best_iteration,"\t")
  cat(temp_train_rmse,"\t")
  cat(temp_test_rmse,"\n")
  
  xgb_train_rmse[j] <- temp_train_rmse
  xgb_test_rmse[j] <- temp_test_rmse 
  round[j] <- m_xgb_untuned$best_iteration
  
  
  # c(temp_train_rmse, temp_test_rmse)
}



set.seed(123)
model <-
  xgboost(
    data = BoostTrainData %>% select(-price) %>% as.matrix(),
    label = BoostTrainData %>% select(price) %>% as.matrix(),
    nrounds = round[which.min(xgb_test_rmse)],
    objective = "reg:squarederror",
    early_stopping_rounds = 3,
    max_depth = hyper_grid[which.min(xgb_test_rmse),]$max_depth,
    eta = hyper_grid[which.min(xgb_test_rmse),]$eta
  ) 



summary(model)

pred <- predict(model, testData %>% as.matrix())

writeSubmit(pred)

```




```{r}
NetTrainData <- trainData %>% select(!is.character) %>% select(-id)

NetTrainX <- NetTrainData %>% select(-price) %>% as.matrix() 
NetTrainY <- NetTrainData %>% select(price) %>% as.matrix()

rmse <- function(y, y_hat){
  sqrt(mean((y - y_hat)^2))
}

inputSize <- dim(NetTrainX)[2] 
offsetSize <- 0.5

scaleSize <- inputSize * offsetSize

model <- keras_model_sequential() %>%
  layer_dense(units = scaleSize*2, activation = "softplus", input_shape = dim(NetTrainX)[2]) %>%
  layer_dropout(rate = 0.33) %>%
  layer_dense(units = scaleSize*4, activation = "softplus") %>%
  layer_dropout(rate = 0.33) %>%
  layer_dense(units = scaleSize*8, activation = "softplus") %>%
  layer_dropout(rate = 0.33) %>%
  layer_dense(units = scaleSize*4, activation = "softplus") %>%
  layer_dropout(rate = 0.33) %>%
  layer_dense(units = scaleSize*2, activation = "softplus") %>%
  layer_dropout(rate = 0.33) %>%
  layer_dense(units = scaleSize*0.5, activation = "softplus") %>%
  layer_dense(units = scaleSize*0.25, activation = "softplus") %>%
  layer_dense(units = 1, activation = "softplus")

model %>% compile(
   loss = "mse",
   optimizer =  "nadam", 
   metrics = c("mape","mse")
 )
 
model %>% summary()
```

```{r}
set.seed(123)
model %>% fit(NetTrainX, NetTrainY, epochs = 100, batch_size = 128, validation_split = 0.2,verbose = 2)
 
scores <- model %>% evaluate(NetTrainX, NetTrainY, verbose = 0)
print(scores)
```


```{r}
summary(model)

pred <- predict(model, testData %>% select(-id) %>% as.matrix())

writeSubmit(pred)
```


```{r}

```



